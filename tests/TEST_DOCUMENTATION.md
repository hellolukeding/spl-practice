# SPL Practice 测试文档

## 测试文件结构

```
tests/
├── spl-practice.ts                    # 原始基础测试文件（保留兼容性）
├── spl-practice-basic.ts              # 简化的基础功能测试
└── spl-practice-comprehensive.ts      # 完整的综合测试套件
```

## 测试文件说明

### 1. `spl-practice-basic.ts` - 基础功能测试

**目的**: 快速验证核心功能是否正常工作

**测试内容**:

- ✅ 创建用户资料
- ✅ 更新用户资料
- ✅ 增加用户余额
- ✅ 基础数据验证

**运行时间**: ~2-3 秒

### 2. `spl-practice-comprehensive.ts` - 完整测试套件

**目的**: 全面测试所有功能、边界条件和安全性

**测试模块**:

#### 👤 用户资料管理

- ✅ 创建用户资料
- ✅ 更新用户资料
- ✅ 增加用户余额
- 🚫 未授权访问保护

#### 🪙 Token 功能

- ✅ 创建 Token 元数据
- ✅ 每日铸造 Token
- 🚫 防止重复铸造

#### ⚠️ 错误处理

- 🔄 余额溢出保护
- 🚫 边界条件测试

#### 🔍 数据完整性验证

- 📊 所有账户数据验证
- 💰 代币余额验证
- 📋 完整性检查

**运行时间**: ~10-15 秒

## 运行测试

### 运行所有测试

```bash
anchor test
```

### 运行特定测试文件

```bash
# 基础测试
yarn ts-mocha -p ./tsconfig.json -t 1000000 'tests/spl-practice-basic.ts'

# 完整测试
yarn ts-mocha -p ./tsconfig.json -t 1000000 'tests/spl-practice-comprehensive.ts'
```

### 跳过构建运行测试

```bash
anchor test --skip-build
```

## 测试结果示例

### 基础测试输出

```
SPL Practice 基础测试
  ✅ 用户资料创建成功: [交易签名]
  ✅ 用户资料更新成功: [交易签名]
  ✅ 余额增加成功: [交易签名]
  🎉 基础功能测试完成!
  ✔ 创建和管理用户资料 (XXXms)

1 passing (Xs)
```

### 完整测试输出

```
SPL Practice 完整测试
  👤 用户资料管理
    ✔ ✅ 创建用户资料
    ✔ ✏️ 更新用户资料
    ✔ 💰 增加用户余额
    ✔ 🚫 应该阻止未授权用户更新资料
  🪙 Token 功能测试
    ✔ 📊 创建 Token 元数据
    ✔ 🎁 每日铸造 Token
    ✔ 🚫 应该阻止同一天重复铸造
  ⚠️ 错误处理测试
    ✔ 🔄 余额溢出保护
  🔍 数据完整性验证
    ✔ 📊 验证所有账户数据

18 passing (XXs)
```

## 测试覆盖范围

### 功能覆盖

- ✅ 用户资料 CRUD 操作
- ✅ Token 元数据管理
- ✅ 每日铸造机制
- ✅ PDA 地址计算
- ✅ 账户约束验证

### 安全测试

- ✅ 权限验证
- ✅ 重复操作防护
- ✅ 数值溢出保护
- ✅ 未授权访问阻止

### 边界条件

- ✅ 最大数值处理
- ✅ 空账户状态
- ✅ 时间相关逻辑
- ✅ 错误状态处理

## 测试最佳实践

1. **测试隔离**: 每个测试用例使用独立的账户和数据
2. **错误验证**: 使用 `expect.fail()` 和 `AnchorError` 验证错误情况
3. **数据验证**: 详细验证账户数据的每个字段
4. **清晰输出**: 使用表情符号和清晰的日志信息
5. **性能监控**: 记录交易签名和执行时间

## 依赖包

测试使用的主要依赖:

- `@coral-xyz/anchor`: Anchor 框架
- `@solana/web3.js`: Solana 区块链交互
- `@solana/spl-token`: SPL Token 操作
- `chai`: 断言库
- `mocha`: 测试运行器

## 故障排除

### 常见问题

1. **空投失败**: 确保本地测试网正在运行
2. **PDA 计算错误**: 检查种子值是否正确
3. **账户约束失败**: 验证账户权限和所有权
4. **交易失败**: 检查签名者和账户配置

### 调试技巧

1. 使用 `console.log()` 输出关键信息
2. 检查交易日志获取详细错误信息
3. 验证账户余额和状态
4. 使用 Solana Explorer 查看交易详情
